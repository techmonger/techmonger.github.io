<!DOCTYPE html>
<html lang="en"> <head><link rel="shortcut icon" href="/static/images/TechMonger%28CC%29.ico"><title>Script to Recover Web Application After Crash - Tech Monger</title><meta charset="UTF-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="description" content="In this guide you will learn about simple technique to detect crash of web services and build solution to restart server in Linux like operating system."><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="canonical" href="/73/crash-auto-restart/"><style>.lead{font-size:1.25rem;font-weight:300}</style></head> <body> <div class="container"> <header class="container"> <h1 class="row"><a href="/">Tech Monger</a></h1> <p class="lead row">Programming, Web Development and Computer Science.</p> </header> <span id="skiplinks" class="skip-link"> <a href="#main" title="Main Content on Page">Skip to main content</a>| <a href="#sidebar" title="Sidebar of Blog">Skip to information by topic</a> </span> <div class="row"> <main class="col-lg-9" id="main"> <article class="container" itemscope itemtype="https://schema.org/BlogPosting"> <h2 itemprop="headline">Auto Restart Web Server After Crash</h2> <p itemprop="datePublished" title="19-06-10 11:20:17Z">Posted June 10, 2019</p> <div itemprop="articleBody"> <p class="lead"> So you have web application running in production but it goes down unexpectedly and you get midnight calls to take up application. In this post we will build simple script that will recover web application after server crash due to over resource utilization. </p> <hr> <h3 class="top2">Over Utilization of CPU or RAM</h1> <p> Web server could crash due to variety of reasons but in this guide we will deal with crashes that occur due to <em>High CPU or Memory Consumption</em> by web server process. However you can use below script to recover web server which crashes due to any other reason. </p> <p> If request arrives at web server and web server is under heavy resource load, it will not respond to the request and request will time out. Also it might happen that web server process is itself a resource hungry and over utilisation of resources stops web server completely. </p> <p> This is very common phenomenon when you have very light weight virtual machine hosting your web server with limited CPU and Memory such as <a href="/45/static-webiste-google-cloud/" title="f1 micro instance">google cloud's f1 micro instance</a>. We encountered this issue running web application written in <a href="/tag/flask" title="Flask Web Application Development">Flask</a> which was hosted on Gunicorn web server over <a href="/tag/google-cloud/" title="Google" cloud web site hosting">Google Cloud</a>. </p> <hr> <h3>Auto Restart Script</h3> <p>We will build auto restart script which will have following two components.</p> <ol> <li>Crash Detection</li> <li>Crash Recovery</li> </ol> <h4>Crash Detection</h4> <p> Whenever web server responds to http request <em>correctly</em>, it sends <strong>HTTP Status code 200</strong> inside HTTP header. So if there is crash then server will never send status code <code>200</code>. We will leverage on this technique to detect web server crash.</p> <p> We will use <code>cURL</code> to send http request to web site on page which <strong>always responds with status code 200</strong>. If status code is not <code>200 OK</code> then we will trigger recovery component. </p> <h4>Crash Recovery</h4> <p> Once we are ascertained that web server is crashed and hence not responding, we can take recovery action. Recovery depend upon what action is more appropriate to take web application up. </p> <p> Restarting web server is appropriate recovery in most of the cases. But restarting web server does not work when web server process itself is responsible for over utilisation because web server does not respond to the restart or stop command. Hence we will need to restart complete <abbr title="virtual machine">VM</abbr> to recover from crash. </p> <h4>Building Crash Detection and Recovery Script</h4> <p>Below we will make web request with curl and check status code of response. If it is not <code>200</code> we will take recovery action i.e. reboot VM. You can take recovery action according your requirement. We will schedule this script on same machine as of web server.</p> <h5 class="text-center"><code>auto_recover.sh</code></h5> <pre class="bash"><code>#!/bin/bash

status=`curl -s -o /dev/null -w "%{http_code}" https://example.com`
echo `date` $status >> crash_checks.log

if [ "$status" -ne "200" ]
then
       # Take any appropriate recovery action here.
	echo "webserver seems down, initiating reboot." >> check.log
	sudo reboot
fi
</code></pre> <h5>Additional Setting</h5> <p> In above example we are rebooting complete VM and need make sure that after reboot web application get started automatically. We will achieve it with cronjob. Cronjob will also help us schedule above script run after specified interval. </p> <p>Open crontab in edit mode to create cronjob.</p> <pre class="bash"><code>$ crontab -e</code></pre> <p>Schedule web application auto restart and crash detection script.</p> <pre class="bash"><code># To start webapp automatically after reboot
@reboot sh /path/to/webapp/startup/script/start.sh

# To trigger crash detection script after every 5 minutes
*/5 * * * * sh /path/to/script/auto_recover.sh

</code></pre> <hr> <h3>Conclusion</h3> <div class="card"> <p class="card-body"> We learned how to write custom script to detect and recover web application when web server goes down unexpectedly. This technique help us maintain high availability despite of web server crash. Though this script is useful, we should always try to <strong>find actual cause of the crash and fix it accordingly</strong>. </p> </div> </div> <p class="top3">Tagged Under :<span itemprop="keywords"> <a href="/tag/flask/">Flask</a> <a href="/tag/google-cloud/">Google Cloud</a> <a href="/tag/linux/">Linux</a> <a href="/tag/ubuntu/">Ubuntu</a> <a href="/tag/web/">Web</a> </span> </p> </article> <div class="top3"> <div class="col-sm-9"> <span class="float-left"> <a class="btn btn-secondary btn-md" role="button" aria-disabled="false" href="/72/informatica-postgres-odbc/" title="Fix Informatica Postgres ODBC Connection">Previous</a> </span> <span class="float-right"> <a class="btn btn-secondary btn-md disabled" role="button" aria-disabled="true" href="#">Next</a> </span> </div> </div> </main> <aside class="col-lg-3 top5" id="sidebar"> <div class="text-right"> <h3>Tags</h3> <nav> <ul> <li class="list-unstyled"><a href="/tag/davmail/" title="Davmail Setup and Configuration">Davmail</a></li> <li class="list-unstyled"><a href="/tag/flask/" title="Flask Web Development">Flask</a></li> <li class="list-unstyled"><a href="/tag/google-cloud/" title="Google Cloud Tutorials and Examples">Google Cloud</a></li> <li class="list-unstyled"><a href="/tag/informatica/" title="Informatica Administration Tutorials">Informatica</a></li> <li class="list-unstyled"><a href="/tag/linux/" title="Linux Desktop and Server - Tutorials">Linux</a></li> <li class="list-unstyled"><a href="/tag/localtunnel/" title="Localtunnel Tutorials -  HTTP Tunnel in Action">Localtunnel</a></li> <li class="list-unstyled"><a href="/tag/open-source/" title="Tutorials about open source software ">Open Source</a></li> <li class="list-unstyled"><a href="/tag/python/" title="Python Programming">Python</a></li> <li class="list-unstyled"><a href="/tag/raspberry-pi/" title="Raspberry Pi Tutorials and Hacks">Raspberry Pi</a></li> <li class="list-unstyled"><a href="/tag/thunderbird/" title="Thunderbird Tutorials">Thunderbird</a></li> <li class="list-unstyled"><a href="/tag/ubuntu/" title="Ubuntu Tutorials">Ubuntu</a></li> <li class="list-unstyled"><a href="/tag/web/" title="Tutorials for Full Stack Web Developers">Web</a></li> <li class="list-unstyled"><a href="/tag/windows/" title="Windows Software and Tutorials">Windows</a></li> <li class="list-unstyled"><a href="/tag/wordpress/" title="Wordpress Tutorials and Guides">Wordpress</a></li> </ul> </nav> </div> <div class="top4 bottom4 float-left"> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class="adsbygoogle" style="display:inline-block;width:336px;height:280px" data-ad-client="ca-pub-1476292113673713" data-ad-slot="8720400182"></ins> <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script> <div> <div class="text-center"> <a class="top5" href="/feeds/" title="Atom Feed - Tech Monger"><i class="fa fa-rss" aria-hidden="true"></i>&nbsp;&nbsp;Feeds</a> </div> </aside> </div> <hr class="top3"> <footer class="top5 text-secondary"> <div class="container-fluid text-center text-md-left"> <div class="row"> <div class="col-md-4 mt-md-0 mt-3"> <h5 class="text-uppercase">About</h5> <p>Techmonger is a web log which shares interesting articles about computer science, programming and web development.</p> </div> <hr class="clearfix w-100 d-md-none pb-3"> <div class="col-md-3 mb-md-0 mb-3"> <h5 class="text-uppercase">Pages</h5> <ul class="list-unstyled"> <li> <a href="/privacy.html">Privacy Policy</a> </li> <li> <a href="/contact.html">Contact</a> </li> </ul> </div> <div class="col-md-5 mb-md-0 mb-3"> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class="adsbygoogle" style="display:inline-block;width:468px;height:60px" data-ad-client="ca-pub-1476292113673713" data-ad-slot="1929762560"></ins> <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
            </script> </div> </div> </div> </footer> <div class="top3"></div> <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css"> <script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script> <script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#ffffff"
    },
    "button": {
      "background": "#e0e0e0",
      "text": "#0a0202"
    }
  },
  "theme": "edgeless",
  "content": {
    "dismiss": "Accept",
    "href": "/privacy.html"
  }
})});
</script> </div> <link rel="stylesheet" type="text/css" href="/static/css/style.css"> <script src="/static/js/scripts.js"></script> <script>hljs.initHighlightingOnLoad();</script> </body> </html>