<!DOCTYPE html>
<html lang="en"> <head><link rel="shortcut icon" href="/static/images/TechMonger%28CC%29.ico"><title>Python Programming - Tech Monger</title><meta charset="UTF-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="description" content="Here you read about various aspects of python programming language with code samples and easy to follow how to tutorials."><meta name="viewport" content="width=device-width, initial-scale=1"></head> <body> <div class="container"> <header class="container"> <h1 class="row"><a href="/">Tech Monger</a></h1> <p class="lead row">Programming, Web Development and Computer Science.</p> </header> <span id="skiplinks" class="skip-link"> <a href="#main" title="Main Content on Page">Skip to main content</a>| <a href="#sidebar" title="Sidebar of Blog">Skip to information by topic</a> </span> <div class="row"> <main class="col-lg-10" id="main"> <h3>Tagged Under : Python</h3> <article class="container top2" itemscope itemtype="https://schema.org/BlogPosting"> <h2><a href="/1/openshift-flask-app/">How to create simple Flask application on Openshift</a></h2> <p title="16-12-23 08:16:04Z">Posted December 23, 2016</p> <p class="lead">In this tutorial we will learn deployment of flask application on openshift. I assume that you have some working knowledge of <em>openshift</em>, <em>python</em>, <em>flask</em> and <em>git</em>. </p> <h3>Prerequisites</h3> <p>Make sure you answer affirmatively to the following things before we proceed with this tutorial.</p> <ul> <li> <p>Have working Openshift account.</p> </li> <li> <p>Have created Openshift namespace.</p> </li> <li> <p>Have created Python application on Openshift.</p> </li> <li> <p>Can ssh into application repository using </p> <ul> <li class="hljs"> ssh app-id@app-name-namespace.rhcloud.com </li> <li class="hljs">ssh 5845734b0c1e66a7fd00002f@blog-monger.rhcloud.com </li> </ul> </li> <li> <p>Have cloned application git repository locally using</p> <ul> <li class="hljs"> git clone ssh://application-id@app-name-namespace.rhcloud.com/~/git/tech.git/ </li> <li class="hljs"> git clone ssh://5845734b0c1e66a7fd00002f@blog-monger.rhcloud.com/~/git/blog.git/ </li> </ul> </li> <li> <p class="top1">Can see default openshift python web page at </p> <ul> <li> <p>https://app-name-namespace.rhcloud.com</p> </li> <li> <p>https://blog-monger.rhcloud.com</p> </li> </ul> </li> </ul> <p class="lead">If you have answered <b>Yes</b> to above questions then let’s start with <em>Hello World Flask App</em>.</p> <h3>Creating Application Locally</h3> <p>Before deploying we will create flask application locally. You should have <code>flask</code> package installed locally in your python setup. You can either install flask globally or better install it in virtual environment using</p> <p><code class="hljs">pip install flask</code></p> <p>Create file <code>web_app.py</code> in your project folder and copy following hello world app code into the file.</p> <pre><code class="python">from flask import Flask
app = Flask(__name__)

@app.route("/")
def hello():
    return "Hello World!"

if __name__ == "__main__":
    app.run()
</code></pre> <p>Make sure you are able to see <em>Hello World!</em> in your browser by running created program using</p> <p><code class="hljs">python web_app.py</code></p> <p>If you face error in above make sure <code>flask</code> is installed correctly and try again.</p> <h3>Local Openshift Repository</h3> <p>In the cloned openshift repository you would see following three files, each has its purpose.</p> <ul> <li><code>requirements.txt</code> Application Dependencies </li> <li><code>setup.py</code> Application Metadata and Required Packages</li> <li><code>wsgi.py</code> WSGI Interface</li> </ul> <p>Note that the default openshift python web page code stored in wsgi.py file.</p> <h3>Editing Local Repository</h3> <p>Update file <code>setup.py</code> with metadata and required installation packages. Your <code>setup.py</code> file should have following content</p> <pre><code>from setuptools import setup

setup(name='HelloWorld',
      version='1.0',
      description='Simple flask openshift application',
      author='Tech Monger',
      author_email='techmonger@example.com',
      url='http://www.python.org/sigs/distutils-sig/',
      install_requires=['Flask=0.11.1'],
     )
</code> </pre> <p>Note that we have removed <em>Django</em> from <code>install_requires</code> and added <em>flask</em>.</p> <p>Now add <code>web_app.py</code> application file that we have created earlier into this repository.</p> <p>Remove existing default openshift python code from <code>wsgi.py</code> and import web application in <code>wsgi.py</code>. Your <code>wsgi.py</code> file should have following content.</p> <pre class="prettyprint"><code>#!/usr/bin/python
import os

virtenv = os.environ['OPENSHIFT_PYTHON_DIR'] + '/virtenv/'
virtualenv = os.path.join(virtenv, 'bin/activate_this.py')
try:
    execfile(virtualenv, dict(__file__=virtualenv))
except IOError:
    pass
#
# IMPORTANT: Put any additional includes below this line.  If placed above this
# line, it's possible required libraries won't be in your searchable path
#

# Importing Hello World application

from web_app import app as application
</code></pre> <p>If you take a look at content of <code>wsgi.py</code> file then you would find that openshift internally uses virtual environment for your application and activates same before starting of the application.</p> <p>Keep <code>requirements.txt</code> empty as we will discuss more about it further.</p> <h3>Deploying Application</h3> <p>Before we push local changes make sure you have committed the same. To commit changes enter into the local repository folder and do following git operations.</p> <pre class="hljs bash"><code>git add .
git commit -m “Hello World App”
git push</code></pre> <p>Once pushed you would see changes getting deployed on openshift by application restart.</p> <p>Now you will be able to find your application up and running at application url https://app-name-namespace.rhcloud.com.</p> <h3>Manually Installing Packages</h3> <p>You can also add your dependencies into <code>requirements.txt</code> instead of <code>setup.py</code> but openshift would not install dependencies automatically due to the way directory permissions on openshift are configured. There is workaround to install dependencies manually. </p> <p>Your <code>requirements.txt</code> file should have following content. You can get these dependencies by doing </p> <pre class="hljs bash"><code>pip freeze</pre></code> <pre class="hljs"><code>Flask==0.11.1
Jinja2==2.8
MarkupSafe==0.23
Werkzeug==0.11.11
argparse==1.2.1
click==6.6
itsdangerous==0.24
wsgiref==0.1.2 </code></pre> <p><em>Add, commit and push</em> local changes.</p> <pre class="hljs"><code>git add .
git commit -m “Manual dependency installation”
git push</code></pre> <p class="lead">Upon pushing you would see following error.</p> <blockquote class="hljs"> remote: The directory '/var/lib/openshift/5855124a7628e1df1800006e/.cache/pip/http' or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing pip with sudo, you may want sudo's -H flag. </blockquote> <p class="lead">While building package you would get following error.</p> <blockquote class="hljs"> remote: OSError: [Errno 13] Permission denied: '/var/lib/openshift/585505782d5271c9f400013d/.cache' </blockquote> <h4>To install dependencies manually perform the following</h4> <ol> <li> <p>ssh openshift application like below for each package.</p> <ul> <li class="hljs">ssh app-id@app-name-namespace.rhcloud.com </li> <li class="hljs">ssh 5845734b0c1e66a7fd00002f@blog-monger.rhcloud.com </li> </ul> </li> <li> <p class="top1">Once logged in, activate virtual environment of your application remotely on openshift</p> <ul> <li> <p class="top1">Navagate to openshift python directory using following environment variable</p></li> <ul> <li class="hljs">cd $OPENSHIFT_PYTHON_DIR</li> </ul> </li> <li> <p class="top1">Activate Virtual Environment</p> <ul> <li class="hljs">. virtenv/bin/activate</li> </ul> </li> </ul> </li> <li> <p class="top1">Install dependencies from <code>requirements.txt</code></p> <ul> <li> <p class="top1">Navigate to application repository using following environment variable</p> </li> <ul> <li class="hljs">cd $OPENSHIFT_REPO_DIR</li> </ul> </li> <li> <p class="top1">Install packages using pip with <code>no-cache</code> flag</p> <ul> <li class="hljs">pip install -r requirements.txt --no-cache</li> </ul> </li> </ul> </li> </ol> <p class="lead">Now you shall see that your all dependencies are installed and application is up and running.</p> </article> <article class="container top2" itemscope itemtype="https://schema.org/BlogPosting"> <h2><a href="/2/simple-parabola-matplotlib/">Plotting Parabola (y = x<sup>2</sup>) using Python and Matplotlib </a></h2> <p title="17-06-24 11:03:14Z">Posted June 24, 2017</p> <p>To plot graphs in Python you can use popular library Matplotlib. I would recommend creating separate virtual environment and then installing matplotlib.</p> <h2>Installing matplotlib in Virtual Environment</h2> <p>Create virtual environment using following command </p> <pre><code>virtualenv ~/.venvs/matplotlib</code></pre> <p>Activate virtual environment</p> <pre><code>.  ~/.venvs/matplotlib/bin/activate</code></pre> <p>Install Matplotlib</p> <pre><code>pip install matplotlib</code></pre> <h2>Graphing Parabola</h2> Below code will graph simple parabola y = x<sup>2</sup>. Range of function would be (-50, 50). <pre>
<code>
import numpy as np
import matplotlib.pyplot as plt

x_cords = range(-50,50)
y_cords = [x*x for x in x_cords]

plt.scatter(x_cords, y_cords)
plt.show()
</code>
</pre> <h2>Output</h2> <figure class="figure"> <img class="img-fluid" src="/static/images/2/simple-parabola.png " alt="Simple Parabola in Matplotlib Python"> <figcaption class="figure-caption text-center">Parabola y = x<sup>2</sup>.</figcaption> </figure> </article> <article class="container top2" itemscope itemtype="https://schema.org/BlogPosting"> <h2><a href="/4/secure-passwords-werkzeug/">How to store passwords securely using Werkzeug</a></h2> <p title="17-11-26 09:38:45Z">Posted November 26, 2017</p> <p class="lead">In this article we will learn how to implement secure user authentication system using python <code>werkzeug</code>. We will store secure passwords with salted hashes and later we will verify entered user password in plaintext against it's password hash to authenticate user.</p> <p><em>Werkzeug</em> is python library which contains lot of development and debugging tools for implementation of web application gateway interface(<code>WSGI</code>) applications. The good part is you can use this system not only for your web applications but also for standalone python applications like desktop apps, scripts, mobile apps and so on.</p> <h3>Install Werkzeug with pip</h3> <code class="hljs">pip install werkzeug</code> <div class="card top2"> <p class="text-info top2">Skip this step if you are using <code>flask</code> because flask will automatically install <code>werkzeug</code> as <code>werkzeug</code> is one of the dependency for <code>flask</code>.</p> </div> <h3 class="top2">Understanding Secure Passwords</h3> <p>Before we delve into the code it's good idea to zero in on <strong>what is secure password storage</strong>.</p> <div class="card"> <ul class="card-body"> <li>Passwords <b>will not be</b> stored as plaintext in database.</li> <li>Password will be stored as <b>hash</b> which is <em>irreversible</em> to plaintext. (one way hash).</li> <li>With given hash attacker <b>cannot</b> guess plaintext.</li> <li>Each user password will be hashed with <b>salt</b> to mitigate <em class="text-danger">rainbow table attacks</em>; Just in case if database got compromised.</li> </ul> </div> <h3 class="top2">Werkzeug Security Functions</h3> <p>There are various security functions available in the <code>werkzeug.security</code> but we are interested in <code>generate_password_hash</code> and <code> check_password_hash</code>.</p> <h4 class="top1">generate_password_hash</h4> <p><code>generate_password_hash</code> takes <b>plaintext password</b>, <b>hashing method</b> and <b>salt length</b> as an input to produce hashed password. By default it produces salt string with length 8. </p> <pre class="python"><code>from werkzeug.security import generate_password_hash
print generate_password_hash("P1ain-text-user-passw@rd", "sha256")
</code></pre> <code>sha256$lTsEjTVv$c794661e2c734903267fbc39205e53eca607f9ca2f85812c95020fe8afb3bc62</code> <p class="top2">Note that output string contains <b>hashing method</b>, <b>salt</b> and <b>hashed password</b> concatenated with the <code>$</code> (dolor). Store hashed string <b>as it is</b> in your database under column <b>hashed_password</b>.</p> <h4 class="top1">check_password_hash</h4> <p><code>check_password_hash</code> takes two inputs <b>password hash</b> and <b>plaintext password</b> and returns <code>True</code> if hash matches actual hash of plaintext password else returns <code>False</code> <pre class="python"><code>from werkzeug.security import check_password_hash

print check_password_hash("sha256$lTsEjTVv$c794661e2c734903267fbc39205e53eca607f9ca2f85812c95020fe8afb3bc62", "P1ain-text-user-passw@rd")

>> True
</code></pre> <pre class="python"><code>from werkzeug.security import check_password_hash

print check_password_hash("sha256$lTsEjTVv$c794661e2c734903267fbc39205e53eca607f9ca2f85812c95020fe8afb3bc62", "wrong-passw@rd")

>> False
</code></pre> <h3 class="top2">Conclusion</h3> <div class="card top2"> <div class="card-body"> <li class="top1">When you allow user to signup use <code>generate_password_hash</code> and store hashed version of password in database under column <b>hashed_pwd</b>.</li> <li class="top1"><strong>Do not store plaintext password.</strong></li> <li class="top1">When you authenticate user via sign in use <code>check_password_hash</code> by passing already <b>hashed password</b> for user from database and <b>input password</b> (plaintext) to test veracity of password.</li> </div> </article> <article class="container top2" itemscope itemtype="https://schema.org/BlogPosting"> <h2><a href="/10/flask-simple-authentication/">User Login in Flask without Login Extensions</a></h2> <p title="17-12-13 17:55:49Z">Posted December 13, 2017</p> <p class="lead">In this tutorial we will learn how to build simple user authentication mechanism in Flask without using any login extensions. It's good idea to use existing extensions however if you want more control over how user session cookies are getting handled or if you are not sure about working of an existing extensions then you can quickly roll out your own code to build something very simple. We will make use of <em>Flask-SqlAlchemy </em>to read and write into the database.</p> <h3 class="top2">Application Structure</h3> <ul> <li>User DB - Store user details inside sqlite database.</li> <li>Sign Up Form - Creating new users.</li> <li>Login Form - User Login.</li> <li>Home Page - Home page for authorized users.</li> <li>Logout route - To logout users by removing cookie.</li> </ul> <div class="card"> <p class="card-body">You can follow complete tutorial or directly jump into the <a href="#python" title="Flask Simple Login App">python code</a>. At the <a href="#code" title="Flask Simple Login App - Github">end of the tutorial</a> we will push working code on github.</p> </div> <h3 class="top2">User Database</h3> <p>We will create authentication database <code>auth.db</code> in Sqlite with single table <code>User</code>. This table will have following three columns. <h5 class="text-center">User</h5> <table class="table text-center"> <thead> <tr> <th>Column</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>uid (pk)</td> <td>Integer primary key for each user.</td> </tr> <tr> <tr> <td>username (unique)</td> <td>String username with unique constraint assigned to it</td> </tr> <tr> <td>pass_hash</td> <td>String to store password hash of user password</td> </tr> </tbody> </table> <p>We will create <code>auth.db</code> with following <code>User</code> model using Flask Sqlalchemy.</p> <pre><code>app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:////auth.db'</code></pre> <pre><code>class User(db.Model):
    uid = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(100), unique=True, nullable=False)
    pass_hash = db.Column(db.String(100), nullable=False)

    def __repr__(self):
        return '<user %r>' % self.username
</code></pre> <p>Create empty db with User table</p> <pre><code>db.create_all()</code></pre> <h3 class="top2">Templates</h3> <p>We will create following three <code>jinja2</code> templates to serve html pages.</p> <ul class="list-unstyled"> <li><h5 class="top2">Signup Form</h5> <pre><code name="html">&lt;form id=&#34;signup&#34; action=&#34;{{ url_for(&#39;signup')}}&#34; method=&#34;post&#34;&gt;
    Username :  &lt;input type=&#34;text&#34; id=&#34;username&#34; name=&#34;username&#34;&gt;
    Password : &lt;input type=&#34;password&#34; id=&#34;password&#34; name=&#34;password&#34;&gt;
    &lt;input type=&#34;submit&#34; id=&#34;submit&#34; text=&#34;Signup&#34;&gt;
&lt;/form&gt;
</code></pre> </li> <li> <h5 class="top2">Login Form</h5> <pre><code name="html">&lt;form id=&#34;login&#34; action=&#34;{{ url_for(&#39;login')}}&#34; method=&#34;post&#34;&gt;
    Username :  &lt;input type=&#34;text&#34; id=&#34;username&#34; name=&#34;username&#34;&gt;
    Password : &lt;input type=&#34;password&#34; id=&#34;password&#34; name=&#34;password&#34;&gt;
    &lt;input type=&#34;submit&#34; id=&#34;submit&#34; text=&#34;Login&#34;&gt;
&lt;/form&gt;
</code></pre> </li> <li> <h5 class="top2">User Home Page</h5> <p>Simple <b>Hello User</b> page for authorized user with logout link.</p> <pre><code name="html">&lt;h2&gt;Hello {{username.title()}}&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;{{ url_for(&#39;logout', username=username) }}&#34;&gt;Logout&lt;/a&gt;&lt;/p&gt;
</code></pre> </li> </ul> <h3 class="top4" id="python">Login App with Flask Session</h3> <div class="card"> <ol class="card-body"> <li>We will authenticate user on login and store session cookie for user's session.</li> <li class="top1">This session cookie will set value username equal to True. For example if Bob logs in successfully then we will store <code>session["Bob"]=True</code>. </li> <li class="top1">For subsequent requests from Bob we will check value of <code>session["Bob"]</code>. We will only allow Bob to access his home page if value is <code>True</code>.</li> <li class="top1">If there is no <b>Bob</b> cookie or <b>Bob</b> cookie with Value other than True then will abort request with <code>HTTP 401</code>.</li> <li class="top1">Upon logout we will remove Bob's session cookie.</li> </ol> </div> <p class="top2"><strong>If you don't want to expose Username inside cookie then you can store some other unique value for the user.</strong></p> <ul class="list-unstyled"> <h4 class="top2"><li>Required Imports</h4> <p> We would need following imports from <code>flask</code>, <code>flask_sqlalchemy</code> and <code>werkzeug.security</code>.</p> <p><b>Note</b> that we have also imported functions <code>generate_password_hash</code> and <code>check_password_hash</code> from werkzeug's security module to <a href="/4/secure-passwords-werkzeug/" title="Hashed and Salted Password with Werkzeug">store hashed user passwords in database securely</a>.</p> <pre><code name="python">from flask import Flask, render_template, request, url_for, redirect, flash, \
session, abort
from flask_sqlalchemy import sqlalchemy, SQLAlchemy
from werkzeug.security import generate_password_hash, check_password_hash
</code></pre> </li> <li><h4 class="top2">Application Secret Key</h4> <p>To make use of flask session and message flashing we set application secret key. It is of <strong>paramount importance</strong> to configure <em>strong secret key</em> for the security of the application. Flask will make use of this key to sign session cookies.</p> <pre><code name="python">app.config['SECRET_KEY'] = 'configure strong secret key here'
</code></pre> </li> <li><h4 class="top2">Routes</h4> <p>We will build following four flask routes for signup, login, user home page and logout.</p> <ol> <h5 class="top1"><li>Signup</h5> <p>This route will allow new user to register an account. Note that how it's making use of <code>generate_password_hash</code> to <b>store hashed password</b> into database. It will existing username in database and flash message. Once user is created it will redirect user to login page.</p> <pre><code name="python">@app.route("/signup/", methods=["GET", "POST"])
def signup():
    if request.method == "POST":
        username = request.form['username']
        password = request.form['password']

        if not (username and password):
            flash("Username or Password cannot be empty")
            return redirect(url_for('signup'))
        else:
            username = username.strip()
            password = password.strip()

        # Returns salted pwd hash in format : method$salt$hashedvalue
        hashed_pwd = generate_password_hash(password, 'sha256')

        new_user = User(username=username, pass_hash=hashed_pwd)
        db.session.add(new_user)

        try:
            db.session.commit()
        except sqlalchemy.exc.IntegrityError:
            flash("Username {u} is not available.".format(u=username))
            return redirect(url_for('signup'))

        flash("User account has been created.")
        return redirect(url_for("login"))

    return render_template("signup.html")
</code></pre> </li> <h5 class="top1"><li>Login</h5> <p>This route will serve login page for User. It will accept Username and Password in plaintext. Using <code>check_password_hash</code> it will check plaintext password with hashed value stored in database. If hash value matches then it will store session cookie with <code>session[username] = True</code>.</p> <pre><code name="python">@app.route("/login/", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        username = request.form['username']
        password = request.form['password']

        if not (username and password):
            flash("Username or Password cannot be empty.")
            return redirect(url_for('login'))
        else:
            username = username.strip()
            password = password.strip()

        user = User.query.filter_by(username=username).first()

        if user and check_password_hash(user.pass_hash, password):
            session[username] = True
            return redirect(url_for("user_home", username=username))
        else:
            flash("Invalid username or password.")

    return render_template("login_form.html")
</code></pre> </li> <h5 class="top1"><li>User Home</h5> <p>If user is successfully logged in then it should have session cookie for it's username with value <code>True</code>. This route will check that value and show user it's home page. It will abort request with <code>401</code> for the request with invalid cookie. </p> <pre><code name="python">@app.route("/user/< username>/")
def user_home(username):
    if not session.get(username):
        abort(401)
  
    return render_template("user_home.html", username=username)
</code></pre> </li> <h5 class="top1"><li>Logout</h5> <p>This route will get invoked when user logs out of the application. It will remove existing user session cookie.</p> <pre><code name="python">@app.route("/logout/< username>")
def logout(username):
    session.pop(username, None)
    flash("successfully logged out.")
    return redirect(url_for('login'))
</code></pre> </li> </li> </ul> <h3 class="top3">Security Caveats</h3> <div class="card alert-warning"> <ul class="card-body"> <li class="top1">Always use HTTPS for deployment to serve cookies securely.</li> <li class="top1">Test application locally with HTTPS before deployment.</li> <li class="top1">Consider setting expiry date on cookie as flask does not set expiry date on the cookie by default. With flask defaults Session will be expired once browser is closed.</li> <li class="top1">Never store any sensitive information inside cookie. In an event of compromise flask session cookie can be easily decoded.</li> <li class="top1">Configure strong application secret before making use of flask's session.</li> <li class="top1">Use CSRF tokens on forms to prevent cross site request forgery.</li> </ul> </div> <h3 class="top3">Conclusion</h3> <div class="card"> <p class="card-body"> We can build simple user authentication using flask's session to gain more control on user's session cookie. If you want to build complex system then you can consider using flask's user management extensions. We have pushed working source code of <a href="https://github.com/techmonger/flask-simple-login" title="Flask Simple Login Application" id="code" target="_blank">simple login application</a> on github. Feel free to use it in your projects. </p> </div> </article> <article class="container top2" itemscope itemtype="https://schema.org/BlogPosting"> <h2><a href="/5/python-flask-recaptcha/">How to add ReCaptcha to Flask App without Extension</a></h2> <p title="17-11-26 18:04:53Z">Posted November 26, 2017</p> <p class="lead">In this article we will learn to integrate Google ReCaptcha into flask web application without using any flask extension to prevent bots from submitting spam.</p> <p>Traditionally web applications used <code>CAPTCHA</code> containing image with some problem which human could solve but no automated bot can solve. In modern applications this can be achieved by using third party API like Google ReCaptcha.</p> <h3>How Google ReCaptcha API works ?</h3> <ol> <li><p>When you register for recaptcha it provides you two keys.</p></li> <ul> <li><code>Site Key</code> : For Client Side Integration</li> <li><code>Secret Key</code> : For Server Side Integration</li> </ul> <li class="top1"> <p>Whenever user submits a form configured with ReCaptcha it contains payload with name <code>g-recaptcha-response</code>.</p> </li> <li> <p>Upon submitting form your server collects <code>g-recaptcha-response</code> and sends it to google server along with <code>Secret Key</code> to make sure submitted form was from human and not from bot.</p> </li> <li> <p>Google server check <code>g-recaptcha-response</code> sent by you and returns back value suggesting whether form submission is from human or bot .</p> </li> </ol> <h3 class="top2">Registering for ReCaptcha</h3> <p>Before we begin with actual code I assume that you have registered for Google ReCaptcha and have <code>Site Key</code> and <code>Secret Key</code> for your domain.</p> <p>To test application locally add <code>localhost</code> into the domain name while registering like below.</p> <img class="img-fluid" src="/static/images/5/register-recaptcha.png" alt="Google ReCaptcha Registration with localhost"> <h3 class="top3">Implementing ReCaptcha with python and flask</h3> <p class="lead">We will create contact form which is most common use case for using flask and recaptcha. Form will allow user to submit name, email and message. At the end of the tutorial working code will be <a href="#code">pushed on github</a> for easier access.</p> <ol> <h4><li>Client side Implementation</h4> <p>For client side implementation we will include two elements into <code>html</code></p> <ol> <li>ReCaptcha Javascript Code Inside <code>head</code> tag <pre><code name="html">&lt;script src=&#34;https://www.google.com/recaptcha/api.js&#34;&gt;&lt;/script&gt;
</code></pre> </li> <li><code>div</code> to render ReCaptcha Control inside form <pre><code name="html">&lt;div class=&#34;g-recaptcha&#34; data-sitekey=&#34;&#34;&gt;&lt;/div&gt;
</code></pre> </li> <p>For client side we will create simple form with 4 fields. (Name, Email Address, Message and ReCaptcha.</p> <pre><code class="html" name="html">&lt;form action=&#34;/contact/&#34; method=&#34;post&#34;&gt;
Name : &lt;input type=&#34;text&#34; name=&#34;name&#34;&gt;
Email: &lt;input type=&#34;email&#34; name=&#34;email&#34;&gt;
Message: &lt;textarea name=&#34;message&#34; rows=&#34;4&#34; cols=&#34;50&#34;&gt;&lt;/textarea&gt;
Security Check &lt;div class=&#34;g-recaptcha&#34; data-sitekey=&#34;4LyrnTkskdnkneEBBBmkmdkfeeoUMkkeellls1D&#34;&gt;&lt;/div&gt;
&lt;/form&gt;
</code></pre> <b>Note that how we have included <code>sitekey</code> generated during ReCaptcha registration inside <code>div</code> to render ReCaptcha.</b> <code class="hljs html" name="html">&lt;div class=&#34;g-recaptcha&#34; data-sitekey=&#34;&#34;&gt;&lt;/div&gt; </code> <p class="top1">Instead of hardcoding, <code>sitekey</code> you can render it by passing it to <code>view</code> with <code>jinja2</code> from server side python code. <pre><code name="html">&lt;div class=&#34;g-recaptcha&#34; data-sitekey=&#34;{{ sitekey }}&#34;&gt;&lt;/div&gt;
</code></pre> </li> <p class="top2">After rendering example form will look like this.</p> <figure class="figure"> <img src="/static/images/5/flask-recaptcha-contact-form.png" alt="HTML Form with ReCaptcha"> <figcaption class="text-center">Form with ReCaptcha using Python Flask</figcaption> </figure> </li> </ol> <h4><li>Server Side Integration</h4> <ol> <li>Accept form values with <code>g-recaptcha-response</code> <p>Once user has submitted the form by completing ReCaptcha challenge form will get additional field from ReCaptcha under name <code>g-recaptcha-response</code>. Accept it along with other fields with flask contact route.</p> <pre><code>@app.route("/contact/", methods=["GET", "POST"])
def contact():
    if request.method == "POST":
        name = request.form['name']
        email = request.form['email']
        msg = request.form['message']
        captcha_response = request.form['g-recaptcha-response']
</code></pre> </li> <li>Verify <code>captcha_response</code> from ReCaptcha Server <p class="top2"> To check submitted token under <code>captcha_response</code> it needs to be send to google server with payload <code>response</code>. We will use python <code>requests</code>. Server will check <code>captcha_response</code> and respond <code>json</code> object <code>response_text</code>. </p> <p><code>response_text</code> will have key <code>success</code> containing value <code>true</code> if request is valid (from human) and <code>false</code> if it's invalid. We will implement this by defining <code>is_human</code> function in python. </p> <p><b>Note that we need to pass <code>Secret Key</code> generated during registration under payload <code>secret</code> to ReCaptcha server while verifying <code>captcha_response</code></b>.</p> <pre><code>def is_human(captcha_response):
    """ Validating recaptcha response from google server
        Returns True captcha test passed for submitted form else returns False.
    """
    secret = "2PmehhhhsdhsjHGOnjdnsjkfnkjsdn56HDHFjhjh"
    payload = {'response':captcha_response, 'secret':secret}
    response = requests.post("https://www.google.com/recaptcha/api/siteverify", payload)
    response_text = json.loads(response.text)
    return response_text['success']
</code></pre> </li> <li>Process Request <p class="top2">If <code>is_human</code> returns <code>True</code> then we will process contact request else we will show message saying <em>Bots are not allowed !</em></p> <pre><code>@app.route("/contact/", methods=["GET", "POST"])
def contact():
    """ Renders contact form on get and processes it on post. """
    
    sitekey = "your-site-key-here"

    if request.method == "POST":
        name = request.form['name']
        email = request.form['email']
        msg = request.form['message']
        captcha_response = request.form['g-recaptcha-response']
        
        if is_human(captcha_response):
            # Process request here
            status = "Detail submitted successfully."
        else:
             # Log invalid attempts
            status = "Sorry ! Bots are not allowed."

        flash(status)
        return redirect(url_for('contact'))

    return render_template("contact.html", sitekey=sitekey)

</pre></code> </li> </ul> <h3 id="code">Code</h3> <div class="card"> <div class="card-body"> <p clas="top2 lead">Working code for the <a href="https://github.com/techmonger/Flask-ReCaptcha-Contact-Form" title="Flask ReCaptcha Contact Form" target="_blank">flask contact form</a> has been posted on gihub. Please configure site-key and secret key into <code>contact_form.py</code> before running the application.</p> </div> </div> </article> <div class="top3"> </div> </main> <aside class="col-lg-2" id="sidebar"> <h3>Tags</h3> <nav> <ul> <li><a href="/tag/Flask/" title="Flask Web Development">Flask</a></li> <li><a href="/tag/Open-Source/" title="Tutorials about open source software ">Open-Source</a></li> <li><a href="/tag/Python/" title="Python Programming">Python</a></li> <li><a href="/tag/Thunderbird/" title="Thunderbird Tutorials">Thunderbird</a></li> <li><a href="/tag/Ubuntu/" title="Ubuntu Tutorials">Ubuntu</a></li> </ul> </nav> </aside> </div> <div class="top3"></div> </div> <link rel="stylesheet" type="text/css" href="/static/css/style.css"> <script src="/static/js/scripts.js" type="text/javascript"></script> <script type="text/javascript">hljs.initHighlightingOnLoad();</script> </body> </html>